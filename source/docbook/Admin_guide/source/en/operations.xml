<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://docbook.org/xml/5.1/rng/docbook.rng" schematypens="http://relaxng.org/ns/structure/1.0"?>
<?xml-model href="http://docbook.org/xml/5.1/sch/docbook.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>

<!-- The XSL transform inserts these values as Hugo frontmatter. -->
<!-- Additionally, a "date" timestamp is inserted by the stylesheet. -->
<?title  ?> 
<?linkTitle "Operating the mixnet" ?>  <!-- Section menu link text -->
<?url "docs/admin_guide/operations.html" ?> <!-- Required to make image links work -->
<?description "" ?> <!-- Optional -->
<?draft false ?> <!-- Optional -->
<?slug "" ?> <!-- Optional -->
<?layout "" ?> <!-- Optional -->
<?type "" ?> <!-- Optional -->
<?weight 30 ?> <!-- Optional -->

<!DOCTYPE article [
    <!ENTITY % shared-content SYSTEM "../../../shared-content.ent">
    %shared-content;
]>

<article    xmlns="http://docbook.org/ns/docbook"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" 
    xml:id="ops">

    <info>
        <title xml:id="ops.title">Operating the &program_name; mixnet</title>
    </info>
    <para>This section describes tools and methods for managing an operational &program_name;
        mixnet. </para>
    
  <section xml:id="management_socket">
      <info>
          <title xml:id="management_socket.title">Management interface</title>
      </info>
        
    <para>&program_name; provides a management interface that is accessed through a unix domain
            socket. The interface supports run-time changes to nodes without requiring a restart. By
            default, the management interface is disabled. To enable it, change the
                <code>Management</code> section of the node's configuration file so that
                <code>Enable = true</code>:</para>
        <programlisting>[Management]
   Enable = true
   Path = "/<replaceable>node_datadir</replaceable>/management_sock"</programlisting>
        <para>For more information about management configuration, see the details for your node
            type in <link xlink:href="https://katzenpost.network/docs/admin_guide/components.html"
                >Components and configuration of the Katzenpost mixnet</link>.</para>
    <para>Use the <link xlink:href="https://manpages.org/socat">socat</link> command-line utility to
            connect to the management socket and issue commands, with the following syntax:</para>
                
                    <programlisting><prompt># </prompt><command>socat unix:/<replaceable>path-to-datadir</replaceable>/management_sock STDOUT</command></programlisting>
                    <para>The following commands are supported.</para>
                    <itemizedlist>
                        <listitem>
                            <para>QUIT - Exit the management socket session.</para>
                        </listitem>
                        <listitem>
                            <para>SHUTDOWN - Shut down the server gracefully.</para>
                        </listitem>
                        <listitem>
                            <para>ADD_USER - Add a user and associate it with a public link key
                    provided in either hexadecimal or Base64 format.  </para>
                            <programlisting>ADD_USER <replaceable>user</replaceable> <replaceable>key</replaceable></programlisting>
                        </listitem>
                        <listitem>
                            <para>UPDATE_USER - Update a user's link key.</para>
                            <programlisting>UPDATE_USER <replaceable>user</replaceable> <replaceable>key</replaceable></programlisting>
                        </listitem>
                        <listitem>
                            <para>REMOVE_USER - Remove a user.</para>
                            <programlisting>REMOVE_USER <replaceable>user</replaceable></programlisting>
                        </listitem>
                        <listitem>
                            <para>SET_USER_IDENTITY - Set a user's identity key.</para>
                            <programlisting>SET_USER_IDENTITY <replaceable>user</replaceable> <replaceable>key</replaceable></programlisting>
                        </listitem>
                        <listitem>
                            <para>REMOVE_USER_IDENTITY - Remove a user's identity key. This command
                    must be followed up with a  <code>REMOVE_USER</code> command.</para>
                            <programlisting>REMOVE_USER_IDENTITY <replaceable>user</replaceable></programlisting>
                        </listitem>
                        <listitem>
                            <para>USER_IDENTITY - Retrieve a user's identity key.</para>
                            <programlisting>USER_IDENTITY <replaceable>user</replaceable></programlisting>
                        </listitem>
                        <listitem>
                            <para>SEND_RATE - Set the packet rate limit to a per-minute integer
                    value.</para>
                            <programlisting>SEND_RATE <replaceable>value</replaceable></programlisting>
                        </listitem>
                        <listitem>
                            <para>SEND_BURST - Set the packet burst-rate  limit to a  per-minute
                    integer value.</para>
                            <programlisting>SEND_BURST <replaceable>value</replaceable></programlisting>
                        </listitem>
                    </itemizedlist>
                    <para><?oxy_comment_start author="dwrob" timestamp="20250207T110653-0800" comment="What does this mean? Do managments commands actually edit the TOML file? What config parameter does each one of these management commands touch?"?>
            Parameters (all) in server/config. <?oxy_comment_end?></para>
<!--                    <para> Go autogeneted docs: go to godocs.org and search for
                        katezenpost/katzenpost. -\- Baseic dev docs</para>
                    <para>Prometheus logging and graphing is to be recommended (has its own
                        documents)</para>
-->
    
  </section>
    <section xml:id="server-usage">
        <info>
            <title xml:id="server-usage.title">CLI usage for mix server components</title>
        </info>
        <para>Mix server components (mix nodes, gateway nodes, service nodes) may be controlled
            individually from the command line.</para>
        <para>The mix server binary <command>&mixserver_binary;</command> has the following
            command-line usage:</para>
        <programlisting><prompt>$ </prompt>&mixserver_binary; -h
Usage of ./&mixserver_binary;:
  -f string
        Path to the server config file. (default "katzenpost.toml")
  -g    Generate the keys and exit immediately.</programlisting>
        <para>The <code>-f</code> parameter can be used to specify a customized path and filename
            for the server configuration file, which is typically
                <filename>/etc/&mixserver_binary;/katzenpost.toml</filename>.</para>
        <para>The <code>-g</code> option is used to generate the public and private signing and link
            keys. By default, these must be manually copied to the directory defined by the
                <filename>DataDir</filename> parameter in
                <filename>/etc/&mixserver_binary;/katzenpost.toml</filename>.</para>
<!--        <para>Note that if you choose to configure logging to a file one disk, you can implement log
            rotation by moving the log file and then sending the <code>HUP</code> to the authority
            server process. This will cause the daemon to rewrite the log file in the location
            specified by the config file.</para>-->
    </section>
    <section xml:id="voter-usage">
        <info>
            <title xml:id="voter-usage.title">CLI usage for directory authorities</title>
        </info>
        <para>Directory authorities (dirauths) may be controlled individually from the command line. </para>
        <para>The the dirauth binary <command>&dirauth_binary;</command> has the following
            command-line usage:</para>
        <programlisting><prompt>$ </prompt>&dirauth_binary; -h
Usage of &dirauth_binary;:
  -f string
    	Path to the authority config file. (default "katzenpost-authority.toml")
  -g	Generate the keys and exit immediately.
  -v	Get version info.</programlisting>
        <para>The <code>-f</code> parameter can be used to specify a customized path and filename
            for the server configuration file, which is typically
                <filename>/etc/&dirauth_binary;/katzenpost-authority.toml</filename>.</para>
        <para>The <code>-g</code> option is used to generate the public and private signing and link
            keys. By default, these must be manually copied to the directory defined by the
                <filename>DataDir</filename> parameter in
                <filename>/etc/&dirauth_binary;/katzenpost.toml</filename>.</para>
    </section>
    <section>
        <title>Monitoring</title>
        <para>&program_name; logging information can be viewed in real time with the following
            commands:</para>
        <para>
            <programlisting><prompt># </prompt><command><emphasis role="bold">journalctl -u &mixserver_binary; -f -n 2000</emphasis></command></programlisting>
        </para>
        <para>or</para>
        <para>
            <programlisting><prompt># </prompt><command><emphasis role="bold">journalctl -u &dirauth_binary; -f -n 2000</emphasis></command></programlisting>
        </para>
        <para>Logging levels include ERROR, WARNING, NOTICE, INFO, and  DEBUG, with INFO as the
            default. For information about setting the log level, see the documentation for each
            node type in <link
                xlink:href="https://katzenpost.network/docs/admin_guide/components.html">Components
                and configuration of the Katzenpost mixnet</link>.</para>
    </section>
    <section>
        <title>Managing the mixnet
            <?oxy_comment_start author="dwrob" timestamp="20250207T122638-0800" comment="How does this work when there is a dirauth?"?>services<?oxy_comment_end?></title>
        <para>            
            &basic_commands;  
        </para>
    </section>
    <section>

        <title>Where are the files?</title>

            <para>The example shows the components and configuration of a mix node. Other node types
                (gateway, service, and directory authority) have a corresponding binary executable,
                a TOML configuration file, a local private/public key pair, and public keys for each
                peer in the mixnet.</para>
            <para>
                <table frame="all">
                    <title/>
                    <tgroup cols="3">
                        <colspec colnum="1" colname="c1" colwidth="1*"/>
                        <colspec colnum="2" colname="newCol2" colwidth="1*"/>
                        <colspec colnum="3" colname="c2" colwidth="1*"/>
                        <thead>
                            <row>
                                <entry>
                                    <para>Directory</para>
                                </entry>
                                <entry>
                                    <para>File</para>
                                </entry>
                                <entry>Comment</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>
                                    <para><filename>/etc/pq-katzenpost-mixserver</filename></para>
                                </entry>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para/>
                                </entry>
                            </row>
                            <row>
                                <entry/>
                                <entry><filename>katzenpost.toml</filename></entry>
                                <entry>
                                    <para>Main configuration.</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para><filename>/var/lib/pq-katzenpost-mixserver/</filename></para>
                                </entry>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para/>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para><filename>identity.private.pem</filename></para>
                                </entry>
                                <entry>
                                    <para>Local node private identity key</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para><filename>identity.public.pem</filename></para>
                                </entry>
                                <entry>
                                    <para>Local node public identity key</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para><filename>link.private.pem</filename></para>
                                </entry>
                                <entry>
                                    <para>Local private key for encrypting Sphinx packages</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para><filename>link.public.pem</filename></para>
                                </entry>
                                <entry>
                                    <para>Local public key for encrypting Sphinx packages</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para><filename>mixkey-145374.db</filename></para>
                                </entry>
                                <entry>
                                    <para>Peer public identity key</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para><filename>mixkey-145375.db</filename></para>
                                </entry>
                                <entry>
                                    <para>Peer public identity key (etc.)</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para><filename>/usr/local/bin</filename></para>
                                </entry>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para/>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para><filename>pq-katzenpost-authority</filename></para>
                                </entry>
                                <entry>
                                    <para>Directory authority executable</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para/>
                                </entry>
                                <entry>
                                    <para><filename>pq-katzenpost-mixserver</filename></para>
                                </entry>
                                <entry>
                                    <para>Server executable (includes mix, gateway, and service
                                        nodes)</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>
    </section>

</article>
